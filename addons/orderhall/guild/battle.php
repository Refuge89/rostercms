<?php

$d = array(

	'V: Cuteaclysm' => array (
		'Blackwing Descent' => array (

			'152966' => array (
				'icon' => 'trade_archaeology_dwarf_runestone',
				'name' => 'Rough-Hewn Remote',
				'pet' => array (
					'id' => '127850',
					'name' => 'Tinytron',
				),
				'boss' => 'Toxitron',
			),

			'152967' => array (
				'icon' => 'inv_60pvp_trinket2a',
				'name' => 'Experiment-In-A-Jar',
				'pet' => array (
					'id' => '127852',
					'name' => 'Discarded Experiment',
				),
				'boss' => 'Maloriak',
			),

			'152968' => array (
				'icon' => 'achievement_dungeon_naxxramas_heroic',
				'name' => 'Shadowy Pile of Bones',
				'pet' => array (
					'id' => '127853',
					'name' => 'Rattlejaw',
				),
				'boss' => 'Nefarian',
			),
		),
		'The Bastion of Twilight' => array (

			'152969' => array (
				'icon' => 'creatureportrait_twilightshammer_dragonegg_02',
				'name' => 'Odd Twilight Egg',
				'pet' => array (
					'id' => '127857',
					'name' => 'Twilight Clutch-Sister',
				),
				'boss' => 'Theralion',
			),

			'152970' => array (
				'icon' => 'creatureportrait_twilightshammer_summoningportal_water01',
				'name' => 'Lesser Circle of Binding',
				'pet' => array (
					'id' => '127858',
					'name' => 'Bound Stream',
				),
				'boss' => 'Elementium Monstrosity',
			),

			'152972' => array (
				'icon' => 'creatureportrait_twilightshammer_lava_magicball',
				'name' => 'Twilight Summoning Portal',
				'pet' => array (
					'id' => '127859',
					'name' => 'Faceless Minion',
				),
				'boss' => 'Cho\'gall',
			),
		),
		'Throne of the Four Winds' => array (

			'152974' => array (
				'icon' => 'inv_elemental_mote_air01',
				'name' => 'Breezy Essence',
				'pet' => array (
					'id' => '127863',
					'name' => 'Drafty',
				),
				'boss' => 'Rohash',
			),

			'152973' => array (
				'icon' => 'inv_elemental_primal_air',
				'name' => 'Zephyr\'s Call',
				'pet' => array (
					'id' => '127862',
					'name' => 'Zephyrian Prince',
				),
				'boss' => 'Al\'Akir',
			),
		),
		'Firelands' => array (

			'152975' => array (
				'icon' => 'inv_ember',
				'name' => 'Smoldering Treat',
				'pet' => array (
					'id' => '127947',
					'name' => 'Blazehound',
				),
				'boss' => 'Shannox',
			),

			'152976' => array (
				'icon' => 'creatureportrait_twilightshammer_dragonegg_red_01',
				'name' => 'Cinderweb Egg',
				'pet' => array (
					'id' => '127948',
					'name' => 'Cinderweb Recluse',
				),
				'boss' => 'Beth\'tilac',
			),

			'152977' => array (
				'icon' => 'inv_jewelcrafting_nobletopaz_01',
				'name' => 'Vibrating Stone',
				'pet' => array (
					'id' => '127950',
					'name' => 'Surger',
				),
				'boss' => 'Baleroc',
			),

			'152978' => array (
				'icon' => 'inv_misc_enggizmos_18',
				'name' => 'Fandral\'s Pet Carrier',
				'pet' => array (
					'id' => '127951',
					'name' => 'Infernal Pyreclaw',
				),
				'boss' => 'Majordomo Staghelm',
			),
		),
		'Dragon Soul' => array (

			'152979' => array (
				'icon' => 'inv_misc_stoneoil',
				'name' => 'Puddle of Black Liquid',
				'pet' => array (
					'id' => '127952',
					'name' => 'Faceless Mindlasher',
				),
				'boss' => 'Yor\'sahj the Unsleeping',
			),

			'152980' => array (
				'icon' => 'achievment_boss_spineofdeathwing',
				'name' => 'Elementium Back Plate',
				'pet' => array (
					'id' => '127953',
					'name' => 'Corrupted Blood',
				),
				'boss' => 'Spine of Deathwing',
			),

			'152981' => array (
				'icon' => 'ability_deathwing_sealarmorbreachtga',
				'name' => 'Severed Tentacle',
				'pet' => array (
					'id' => '127954',
					'name' => 'Unstable Tendril',
				),
				'boss' => 'Madness of Deathwing',
			),
		),
	),

	'IV: Wrath of the Lick King' => array(
		'Ulduar' => array (
			'142086' => array(
				'icon' => 'inv_ammo_firetar',
				'name' => 'Red-Hot Coal',
				'pet' => array(
					'id' => '115138',
					'name' => 'Magma Rageling',
				),
				'boss' => 'Ignis the Furnace Master',
			),
			'142087' => array(
				'icon' => 'inv_jewelry_necklace_126',
				'name' => 'Ironbound Collar',
				'pet' => array(
					'id' => '115139',
					'name' => 'Ironbound Proto-Whelp',
				),
				'boss' => 'Razorscale',
			),
			'142088' => array(
				'icon' => 'inv_misc_rune_14',
				'name' => 'Stormforged Rune',
				'pet' => array(
					'id' => '115140',
					'name' => 'Runeforged Servitor',
				),
				'boss' => 'Stormcaller Brundir, Runemaster Molgeim, Steelbreaker',
			),
			'142089' => array(
				'icon' => 'inv_fabric_mageweave_02',
				'name' => 'Glittering Ball of Yarn',
				'pet' => array(
					'id' => '115141',
					'name' => 'Sanctum Cub',
				),
				'boss' => 'Auriaya',
			),
			'142090' => array(
				'icon' => 'inv_enchant_dustvision',
				'name' => 'Ominous Pile of Snow',
				'pet' => array(
					'id' => '115142',
					'name' => 'Winter Rageling',
				),
				'boss' => 'Hodir',
			),
			'142091' => array(
				'icon' => 'inv_herbalism_70_yserallineseed',
				'name' => 'Blessed Seed',
				'pet' => array(
					'id' => '115143',
					'name' => 'Snaplasher',
				),
				'boss' => 'Freya',
			),
			'142092' => array(
				'icon' => 'inv_misc_blizzcon09_graphicscard',
				'name' => 'Overcomplicated Controller',
				'pet' => array(
					'id' => '115144',
					'name' => 'G0-R41-0N Ultratonk',
				),
				'boss' => 'Mimiron',
			),
			'142093' => array(
				'icon' => 'ability_rogue_shadowdance',
				'name' => 'Wriggling Darkness',
				'pet' => array(
					'id' => '115145',
					'name' => 'Creeping Tentacle',
				),
				'boss' => 'Yogg-Saron',
			),
		),
		'Trial of the Crusader' => array (
			'142083' => array(
				'icon' => 'inv_egg_02',
				'name' => 'Giant Worm Egg',
				'pet' => array(
					'id' => '115135',
					'name' => 'Dreadmaw',
				),
				'boss' => 'Gormok the Impaler, Acidmaw & Dreadscale & Icehowl',
			),
			'142084' => array(
				'icon' => 'inv_misc_horn_01',
				'name' => 'Magnataur Hunting Horn',
				'pet' => array(
					'id' => '115136',
					'name' => 'Snobold Runt',
				),
				'boss' => 'Gormok the Impaler, Acidmaw & Dreadscale & Icehowl',
			),
			'142085' => array(
				'icon' => 'achievement_dungeon_azjoluppercity_normal',
				'name' => 'Nerubian Relic',
				'pet' => array(
					'id' => '115137',
					'name' => 'Nerubian Swarmer',
				),
				'boss' => 'Anub\'arak',
			),
		),
		'Icecrown Citadel' => array (
			'142094' => array(
				'icon' => 'ability_deathknight_brittlebones',
				'name' => 'Fragment of Frozen Bone',
				'pet' => array(
					'id' => '115146',
					'name' => 'Boneshard',
				),
				'boss' => 'Lord Marrowgar',
			),
			'142095' => array(
				'icon' => 'spell_deathknight_bloodboil',
				'name' => 'Remains of a Blood Beast',
				'pet' => array(
					'id' => '115147',
					'name' => 'Blood Boil',
				),
				'boss' => 'Deathbringer Saurfang',
			),
			'142096' => array(
				'icon' => 'inv_misc_bag_cooking',
				'name' => 'Putricide\'s Alchemy Supplies',
				'pet' => array(
					'id' => '115148',
					'name' => 'Blightbreath',
				),
				'boss' => 'Professor Putricide',
			),
			'142097' => array(
				'icon' => 'inv_misc_skull_06',
				'name' => 'Skull of a Frozen Whelp',
				'pet' => array(
					'id' => '115149',
					'name' => 'Soulbroken Whelpling',
				),
				'boss' => 'Sindragosa',
			),
			'142098' => array(
				'icon' => 'inv_misc_herb_ancientlichen',
				'name' => 'Drudge Remains',
				'pet' => array(
					'id' => '115150',
					'name' => 'Drudge Ghoul',
				),
				'boss' => 'The Lich King',
			),
			
			'142099' => array(
				'icon' => 'achievement_dungeon_icecrown_frostmourne',
				'name' => 'Call of the Frozen Blade',
				'pet' => array(
					'id' => '115152',
					'name' => 'Wicked Soul',
				),
				'boss' => 'The Lich King',
			),
		),
	),

	'III: Drinkin\' From the Sunwell' => array(
		'Black Temple' => array (

			'122104' => array(
				'icon' => 'inv_egg_08',
				'name' => 'Leviathan Egg',
				'pet' => array(
					'id' => '90201',
					'name' => 'Leviathan Hatchling',
				),
				'boss' => 'High Warlord Naj\'entus',
			),
			'122106' => array(
				'icon' => 'spell_fire_blueflamering',
				'name' => 'Shard of Supremus',
				'pet' => array(
					'id' => '90202',
					'name' => 'Abyssius',
				),
				'boss' => 'Supremus',
			),
			'122107' => array(
				'icon' => 'inv_pet_reliquaryanger',
				'name' => 'Fragment of Anger',
				'pet' => array(
					'id' => '90203',
					'name' => 'Fragment of Anger',
				),
				'boss' => 'Reliquary of the Lost',
			),
			'122109' => array(
				'icon' => 'inv_pet_reliquarydesire',
				'name' => 'Fragment of Desire',
				'pet' => array(
					'id' => '90205',
					'name' => 'Fragment of Desire',
				),
				'boss' => 'Reliquary of the Lost',
			),
			'122108' => array(
				'icon' => 'inv_pet_reliquarysuffering',
				'name' => 'Fragment of Suffering',
				'pet' => array(
					'id' => '90204',
					'name' => 'Fragment of Suffering',
				),
				'boss' => 'Reliquary of the Lost',
			),
			'122110' => array(
				'icon' => 'ability_warlock_ancientgrimoire',
				'name' => 'Sultry Grimoire',
				'pet' => array(
					'id' => '90206',
					'name' => 'Sister of Temptation',
				),
				'boss' => 'Mother Shahraz',
			),
		),
		'Hyjal Summit' => array (
			'122111' => array(
				'icon' => 'achievement_bg_xkills_avgraveyard',
				'name' => 'Smelly Gravestone',
				'pet' => array(
					'id' => '90207',
					'name' => 'Stinkrot',
				),
				'boss' => 'Anetheron',
			),
			'122105' => array(
				'icon' => 'ability_deathknight_summongargoyle',
				'name' => 'Grotesque Statue',
				'pet' => array(
					'id' => '90200',
					'name' => 'Grotesque',
				),
				'boss' => 'Azgalor',
			),
			'122112' => array(
				'icon' => 'inv_pet_wisp_purple',
				'name' => 'Hyjal Wisp',
				'pet' => array(
					'id' => '90208',
					'name' => 'Hyjal Wisp',
				),
				'boss' => 'Archimonde',
			),
		),
		'Sunwell Plateau' => array (
			'122113' => array(
				'icon' => 'inv_misc_rune_02',
				'name' => 'Sunblade Rune of Activation',
				'pet' => array(
					'id' => '90212',
					'name' => 'Sunblade Micro-Defender',
				),
				'boss' => 'Brutallus',
			),
			'122115' => array(
				'icon' => 'ability_mount_goatmount',
				'name' => 'Servant\'s Bell',
				'pet' => array(
					'id' => '90214',
					'name' => 'Wretched Servant',
				),
				'boss' => 'Grand Warlock Alythess & Lady Sacrolash',
			),
			'122114' => array(
				'icon' => 'inv_jewelry_necklace_133',
				'name' => 'Void Collar',
				'pet' => array(
					'id' => '90213',
					'name' => 'Chaos Pup',
				),
				'boss' => 'M\'uru / Entropius',
			),
		),
	),

	'II: Attunement Edition' => array(
		'Karazhan' => array(
			'97548' => array(
				'icon' => 'inv_jewelry_necklace_22',
				'name' => 'Spiky Collar',
				'pet' => array(
					'id' => '71014',
					'name' => 'Lil\' Bad Wolf',
				),
				'boss' => 'The Big Bad Wolf',
			),
			'97549' => array(
				'icon' => 'inv_misc_enggizmos_19',
				'name' => 'Instant Arcane Sanctum Security Kit',
				'pet' => array(
					'id' => '71015',
					'name' => 'Menagerie Custodian',
				),
				'boss' => 'The Curator',
			),
			'97551' => array(
				'icon' => 'trade_archaeology_bloodysatyrscepter',
				'name' => 'Satyr Charm',
				'pet' => array(
					'id' => '71033',
					'name' => 'Fiendish Imp',
				),
				'boss' => 'Terestian Illhoof',
			),
			'97550' => array(
				'icon' => 'inv_enchant_essencenethersmall',
				'name' => 'Netherspace Portal-Stone',
				'pet' => array(
					'id' => '71016',
					'name' => 'Netherspace Abyssal',
				),
				'boss' => 'Prince Malchezaar',
			),
		),	
		'Serpentshrine Cavern' => array (
			'97553' => array(
				'icon' => 'spell_nature_elementalshields',
				'name' => 'Tainted Core',
				'pet' => array(
					'id' => '71018',
					'name' => 'Tainted Waveling',
				),
				'boss' => 'Hydross the Unstable',
			),
			'97552' => array(
				'icon' => 'inv_jewelry_necklace_20',
				'name' => 'Shell of Tide-Calling',
				'pet' => array(
					'id' => '71017',
					'name' => 'Tideskipper',
				),
				'boss' => 'Morogrim Tidewalker',
			),
			'97554' => array(
				'icon' => 'inv_pet_bluemurlocegg',
				'name' => 'Dripping Strider Egg',
				'pet' => array(
					'id' => '71019',
					'name' => 'Coilfang Stalker',
				),
				'boss' => 'Lady Vashj',
			),
		),
		'The Eye' => array (
			'97557' => array(
				'icon' => 'inv_feather_13',
				'name' => 'Brilliant Phoenix Hawk Feather',
				'pet' => array(
					'id' => '71022',
					'name' => 'Phoenix Hawk Hatchling',
				),
				'boss' => 'Al\'ar',
			),
			'97555' => array(
				'icon' => 'inv_gizmo_felstabilizer',
				'name' => 'Tiny Fel Engine Key',
				'pet' => array(
					'id' => '71020',
					'name' => 'Pocket Reaver',
				),
				'boss' => 'Void Reaver',
			),
			'97556' => array(
				'icon' => 'inv_enchant_voidsphere',
				'name' => 'Crystal of the Void',
				'pet' => array(
					'id' => '71021',
					'name' => 'Lesser Voidcaller',
				),
				'boss' => 'High Astromancer Solarian',
			),
		),
	),
	'I Classic' => array(
		'Molten Core' => array (
			'93033' => array(
				'icon' => 'ability_creature_cursed_01',
				'name' => 'Mark of Flame',
				'pet' => array(
					'id' => '68665',
					'name' => 'Harbinger of Flame',
				),
				'boss' => 'Sulfuron Harbinger',
			),
			'93034' => array(
				'icon' => 'spell_fire_rune',
				'name' => 'Blazing Rune',
				'pet' => array(
					'id' => '68664',
					'name' => 'Corefire Imp',
				),
				'boss' => 'Magmadar',
			),
			'93035' => array(
				'icon' => 'inv_misc_orb_05',
				'name' => 'Core of Hardened Ash',
				'pet' => array(
					'id' => '68666',
					'name' => 'Ashstone Core',
				),
				'boss' => 'Golemagg the Incinerator',
			),
		),
		'Blackwing Lair' => array (
			'93036' => array(
				'icon' => 'creatureportrait_twilightshammer_dragonegg_red_01',
				'name' => 'Unscathed Egg',
				'pet' => array(
					'id' => '68661',
					'name' => 'Untamed Hatchling',
				),
				'boss' => 'Razorgore the Untamed',
			),
			'93037' => array(
				'icon' => 'mocking_banner',
				'name' => 'Blackwing Banner',
				'pet' => array(
					'id' => '68663',
					'name' => 'Death Talon Whelpguard',
				),
				'boss' => 'Broodlord Lashlayer',
			),
			'93038' => array(
				'icon' => 'inv_jewelry_trinket_06',
				'name' => 'Whistle of Chromatic Bone',
				'pet' => array(
					'id' => '68662',
					'name' => 'Chrominius',
				),
				'boss' => 'Chromaggus',
			),
		),
		'Temple of Ahn\'Qiraj:(AQ40)' => array (
			'93039' => array(
				'icon' => 'inv_misc_volatilelife_green',
				'name' => 'Viscidus Globule',
				'pet' => array(
					'id' => '68660',
					'name' => 'Viscidus Globule',
				),
				'boss' => 'Viscidus',
			),
			'93040' => array(
				'icon' => 'inv_misc_ahnqirajtrinket_01',
				'name' => 'Anubisath Idol',
				'pet' => array(
					'id' => '68659',
					'name' => 'Anubisath Idol',
				),
				'boss' => 'Emperor Vek\'lor',
			),
			'93041' => array(
				'icon' => 'inv_misc_enchantedpearle',
				'name' => 'Jewel of Maddening Whispers',
				'pet' => array(
					'id' => '68658',
					'name' => 'Mini Mindslayer',
				),
				'boss' => 'The Prophet Skeram',
			),
		),
		'Naxxramas' => array (
			'93029' => array(
				'icon' => 'ability_deathknight_brittlebones',
				'name' => 'Gluth\'s Bone',
				'pet' => array(
					'id' => '68654',
					'name' => 'Stitched Pup',
				),
				'boss' => 'Gluth',
			),
			'93030' => array(
				'icon' => 'inv_misc_cat_trinket09',
				'name' => 'Dusty Clutch of Eggs',
				'pet' => array(
					'id' => '68656',
					'name' => 'Giant Bone Spider',
				),
				'boss' => 'Maexxna',
			),
			'93032' => array(
				'icon' => 'creature_sporemushroom',
				'name' => 'Blighted Spore',
				'pet' => array(
					'id' => '68657',
					'name' => 'Fungal Abomination',
				),
				'boss' => 'Loatheb',
			),
		),
	),
);

if ( !isset($_POST['process']) )
{
	$roster->tpl->set_handle('orderhalladd', $addon['basename'] . '/charselect.html');
	$roster->tpl->display('orderhalladd');
}
else
{
	roster_add_css($addon['css_url'],'module');
	
	$roster->api2->ignore_cache = true;
	$roster->api2->set_region($_POST['region']);
	$a = $roster->api2->fetch('character',array('name'=>$_POST['char'],'server'=>$_POST['server'],'fields'=>'battlepets,pets'));
	$roster->api2->ignore_cache = false;
	
	function build_battlepets($data)
	{
		global $roster, $update, $global_plugins;
		
		$pets = array();
		foreach ($data['pets'] as $i => $m)
		{
			$pets[] = $m['itemId'];
		}
		
		return array_values($pets);
	}
	
	/*
	$query = "SELECT * FROM `" . $roster->db->table('api_cache') . "` WHERE `id`='" . $_POST['member_id'] . "' AND `name`='battlepets' LIMIT 1;";
			$result = $roster->db->query($query);
			//echo (bool)$result;
			$row = $roster->db->fetch($result);
			*/
	$bppets = build_battlepets($a);//json_decode($row['json'],true);	

	$e = 0;
foreach ($d as $ach => $b)
{	$e++;
	$total = $comp = 0;
	$roster->tpl->assign_block_vars('exp', array(
				'NAME'	=> $ach,
				'ID'	=> 'exp'.$e,
				'ACTIVE'	=> ($e == 1 ? ' active': ''),
				'ACTIVE2'	=> ($e == 1 ? ' in active': ''),
			));
	foreach ($b as $raid => $pets)
	{
		//echo '<h1>'.$raid.'</h1>';
		$roster->tpl->assign_block_vars('exp.bpraid', array(
				'NAME'	=> $raid,
			));
		foreach ($pets as $pid => $pet)
		{
			//echo $pet['name'].' - '.(in_array($pid, $bppets) ? 'yes' : 'no').'<br>';
			$total++;
			if ( in_array($pid, $bppets) )
			{
				$comp++;
				$img = 'complete';
			}
			else
			{
				$img = 'incomplete';
			}
		
			$roster->tpl->assign_block_vars('exp.bpraid.pets', array(
				'ITEM_NAME'	=> $pet['name'],
				'ITEM_ID'	=> $pid,
				'PET_NAME'	=> $pet['pet']['name'],
				'PET_ID'	=> $pet['pet']['id'],
				'BOSS'		=> $pet['boss'],
				'COLLECTED'	=> $img,
			));
			
		}
		//echo '<br>';
	}
	$roster->tpl->assign_block_vars('exp.per', array(
		'TOTAL'		=> $total,
		'COMP'		=> $comp,
		'BAR'		=> ceil($comp / $total * 100),
		'IMG_URL'	=> $addon['image_url'],
	));
}
	$roster->tpl->assign_vars(array(
			'IMG_URL'	=> $addon['image_url'],
		));
	$roster->tpl->set_handle('bpetslist', $addon['basename'] . '/battle.html');
	$roster->tpl->display('bpetslist');
}


























?>



